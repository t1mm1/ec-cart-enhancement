<?php

use Drupal\commerce\PurchasableEntityInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\commerce_order\Entity\OrderItemInterface;

/**
 * Static cache for popup purchased entity.
 */
function &ec_cart_enhancements_popup_entity_cache(): ?PurchasableEntityInterface {
  static $entity = NULL;
  return $entity;
}

/**
 * Static cache for messages.
 */
function &ec_cart_enhancements_messages_cache(): array {
  static $messages = [];
  return $messages;
}

/**
 * Implements hook_help().
 */
function ec_cart_enhancements_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.ec_cart_enhancements':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Enhances Drupal Commerce cart functionality with improved popup display showing full cart contents.') . '</p>';
      return $output;
  }
}

/**
 * Implements hook_theme().
 */
function ec_cart_enhancements_theme($existing, $type, $theme, $path): array {
  return [
    'ec_cart_enhancement_popup' => [
      'template' => 'ec-cart-enhancement-popup',
      'path' => $path . '/templates',
      'variables' => [
        'product_variation' => NULL,
        'product_variation_entity' => NULL,
        'cart_url' => NULL,
        'messages' => [],
        'has_messages' => FALSE,
        'carts' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK() for ec_cart_enhancement_popup.
 */
function ec_cart_enhancements_preprocess_ec_cart_enhancement_popup(&$variables): void {
  $variables['#attached']['library'][] = 'ec_cart_enhancements/styles';

  $cart_provider = \Drupal::service('commerce_cart.cart_provider');
  $current_store = \Drupal::service('commerce_store.current_store');

  $store = $current_store->getStore();
  if (!$store) {
    $variables['empty'] = TRUE;
    return;
  }

  $carts = $cart_provider->getCarts();
  if (empty($carts)) {
    $variables['empty'] = TRUE;
    return;
  }

  try {
    // Get all carts.
    $data = [];
    foreach ($carts as $cid => $cart) {
      $items = [];
      $count = 0;
      foreach ($cart->getItems() as $item) {
        $count += (int) $item->getQuantity();

        $purchased_entity = $item->getPurchasedEntity();
        if ($purchased_entity) {
          $items[] = [
            'title' => $item->getTitle(),
            'quantity' => (int) $item->getQuantity() > 1 ? (int) $item->getQuantity() : FALSE,
            'unit_price' => $item->getUnitPrice(),
            'total_price' => $item->getTotalPrice(),
          ];
        }
      }

      $data[$cid] = [
        'items' => $items,
        'count' => $count,
        'total' => $cart->getTotalPrice(),
      ];
    }
    $variables['carts'] = $data;

    // Cache.
    if (!empty($cart)) {
      $variables['#cache']['tags'] = ['commerce_order:' . $cart->id(), 'cart'];
      $variables['#cache']['contexts'] = ['user', 'session'];
    }
  }
  catch (\Exception $e) {
    \Drupal::logger('ec_cart_enhancements')->error('Error: @message', [
      '@message' => $e->getMessage(),
    ]);
    $variables['cart_count'] = 0;
  }
}

/**
 * Implements hook_ENTITY_TYPE_presave() for commerce_order_item.
 */
function ec_cart_enhancements_commerce_order_item_presave(OrderItemInterface $order_item): void {
  $purchased_entity = $order_item->getPurchasedEntity();
  if (empty($purchased_entity)) {
    return;
  }

  if (empty($purchased_entity->hasField('license_type'))) {
    return;
  }

  if ($purchased_entity->get('license_type')->isEmpty()) {
    return;
  }

  $quantity = $order_item->getQuantity();
  if ($quantity == 1) {
    $request = \Drupal::requestStack()->getCurrentRequest();
    if ($request && $request->isXmlHttpRequest()) {
      $cache = &ec_cart_enhancements_popup_entity_cache();
      $cache = $purchased_entity;
    }
  }
}
